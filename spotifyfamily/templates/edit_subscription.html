{% extends "base.html" %}

{% block title %}Modifica Sottoscrizione{% endblock %}

{% block content %}
{% if user.is_authenticated %}
<div class="container mt-5">
    <h2>Modifica Sottoscrizione: {{ subscription.name }}</h2>
    
    {% if messages %}
    <div class="mt-3">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Informazioni base sottoscrizione -->
    <div class="card p-4 mt-3">
        <h4>Informazioni Base</h4>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_subscription">
            <div class="mb-3">
                <label for="name" class="form-label">Nome:</label>
                <input type="text" id="name" name="name" class="form-control" value="{{ subscription.name }}" required>
            </div>
            <div class="mb-3">
                <label for="start_date" class="form-label">Data inizio:</label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ subscription.start_date|date:'Y-m-d' }}" required>
            </div>
            <div class="mb-3">
                <label for="renew_period" class="form-label">Periodo di rinnovo (in mesi):</label>
                <input type="number" id="renew_period" name="renew_period" class="form-control" value="{{ subscription.renew_period }}" required>
            </div>
            <button type="submit" class="btn btn-success">Salva modifiche</button>
        </form>
    </div>

    <!-- Gestione Prezzi -->
    <div class="card p-4 mt-3">
        <h4>Gestione Prezzi</h4>
        
        {% if current_price %}
        <div class="mb-4">
            <h5>Prezzo Corrente</h5>
            <form method="post" class="form-inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_current_price">
                <input type="hidden" name="price_id" value="{{ current_price.id }}">
                <div class="form-group mr-2">
                    <label for="current_price" class="mr-2">Prezzo (€):</label>
                    <input type="number" id="current_price" name="current_price" class="form-control" value="{{ current_price.price }}" step="0.01" min="0" required>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Aggiorna</button>
            </form>
            <small class="text-muted">Valido dal {{ current_price.valid_from }}</small>
        </div>
        {% else %}
        <p class="text-warning">Nessun prezzo corrente impostato</p>
        {% endif %}

        <hr>

        <div class="mb-4">
            <h5>Aggiungi Nuovo Prezzo</h5>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_price">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="new_price" class="form-label">Nuovo Prezzo (€):</label>
                        <input type="number" id="new_price" name="new_price" class="form-control" step="0.01" min="0" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="price_valid_from" class="form-label">Valido da:</label>
                        <input type="date" id="price_valid_from" name="price_valid_from" class="form-control" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">Aggiungi Prezzo</button>
                <small class="form-text text-muted">Il prezzo corrente verrà automaticamente chiuso alla data di inizio del nuovo prezzo.</small>
            </form>
        </div>

        {% if price_history %}
        <hr>
        <div>
            <h5>Storico Prezzi</h5>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Prezzo</th>
                        <th>Valido dal</th>
                        <th>Valido al</th>
                    </tr>
                </thead>
                <tbody>
                    {% for price in price_history %}
                    <tr>
                        <td>€{{ price.price }}</td>
                        <td>{{ price.valid_from }}</td>
                        <td>{{ price.valid_to }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Gestione Utenti -->
    <div class="card p-4 mt-3 mb-5">
        <h4>Utenti Iscritti</h4>
        
        <div class="mb-3">
            <h5>Utenti correnti</h5>
            {% if subscription_users %}
            <ul class="list-group">
                {% for sub_user in subscription_users %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        {{ sub_user.username }}
                        {% if sub_user.id == subscription.admin_user.id %}
                        <span class="badge badge-primary ml-2">Amministratore</span>
                        {% else %}
                        <span class="badge badge-secondary ml-2">Membro</span>
                        {% endif %}
                    </span>
                    {% if sub_user.id != subscription.admin_user.id %}
                    <form method="post" style="display:inline;" onsubmit="return confirm('Sei sicuro di voler rimuovere {{ sub_user.username }} dalla sottoscrizione?');">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="remove_user">
                        <input type="hidden" name="user_id" value="{{ sub_user.id }}">
                        <button type="submit" class="btn btn-danger btn-sm" title="Rimuovi utente">
                            <i class="fas fa-user-minus"></i> Rimuovi
                        </button>
                    </form>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">Nessun utente iscritto</p>
            {% endif %}
        </div>

        <hr>

        <div>
            <h5>Utenti disponibili</h5>
            <p class="text-muted">Funzionalità di aggiunta utenti in arrivo...</p>
        </div>
    </div>

    <div class="mb-5">
        <a href="{% url 'home' %}" class="btn btn-secondary">Torna alla Home</a>
    </div>
</div>

{% else %}
<div class="container mt-5">
    <p>Non sei autenticato</p>
    <a href="{% url 'login' %}">Effettua il login</a>
</div>
{% endif %}

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
